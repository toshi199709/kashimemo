<%# ‰∏äÈÉ®Êìç‰Ωú„Éê„ÉºÔºöÊ®™‰∏¶„Å≥ÔºàÂÖ®‰ΩìÔºâ %>
<div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; flex-wrap: wrap; gap: 10px;">
  
  <%# Â∑¶ÔºöÊñ∞Ë¶èÊäïÁ®ø„Éú„Çø„É≥Ôºà„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅÆ„ÅøÔºâ %>
  <div>
    <% if user_signed_in? %>
      <%= link_to "Ôºã Êñ∞„Åó„ÅÑÊäïÁ®ø„Çí‰ΩúÊàê„Åô„Çã", new_post_path, class: "load-btn" %>
    <% end %>
  </div>

<% if user_signed_in? %>
  <div style="display: flex; justify-content: center; margin-top: 20px; margin-bottom: 20px;">
    <%= form_with url: posts_path, method: :get, local: true, html: {
      style: "display: flex; gap: 10px; align-items: center; margin-left: 120px;"
    } do |form| %>
      <%= form.text_field :query, value: params[:query], placeholder: "„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢", style: "width: 300px; padding: 6px; border-radius: 5px;" %>
      <%= form.submit "Ê§úÁ¥¢", style: "padding: 6px 12px;" %>
      <%= hidden_field_tag :category_id, params[:category_id] %>
      <%= hidden_field_tag :sort, params[:sort] %>
    <% end %>
  </div>
<% end %>



  <%# Âè≥Ôºö„Ç´„ÉÜ„Ç¥„É™„Å®‰∏¶„Å≥Êõø„Åà %>
  <div style="display: flex; align-items: center; gap: 10px;">
    <%= form_with url: posts_path, method: :get, local: true do %>
      <%= select_tag :category_id,
            options_for_select(Category.all.map { |c| [c.name, c.id] }, selected: params[:category_id]),
            prompt: "„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû", onchange: "this.form.submit();" %>
      <%= hidden_field_tag :sort, params[:sort] %>
    <% end %>

    <%= link_to "Êñ∞ÁùÄÈ†Ü", posts_path(sort: nil, category_id: params[:category_id]), class: (@sort == "likes" ? "sort-link" : "sort-link active") %>
    |
    <%= link_to "„ÅÑ„ÅÑ„Å≠È†Ü", posts_path(sort: "likes", category_id: params[:category_id]), class: (@sort == "likes" ? "sort-link active" : "sort-link") %>
  </div>
</div>


<%# ÊäïÁ®ø‰∏ÄË¶ß„ÅÆ„É´„Éº„ÉóË°®Á§∫ %>
<% @posts.each do |post| %>
  <div class="post-card" style="position: relative; margin-bottom: 30px; padding-right: 50px;">

    <%= link_to '+', '#',
        class: 'btn btn-sm btn-outline-primary add-to-playlist-btn',
        data: { "post-id": post.id },
        style: 'position: absolute; top: 10px; right: 10px; z-index: 10; border-radius: 50%; width: 32px; height: 32px; padding: 0; line-height: 30px; text-align: center;' %>

    <%= link_to (user_signed_in? && current_user == post.user ? edit_post_path(post) : preview_post_path(post)),
                style: "text-decoration: none; color: inherit; display: block;" do %>

      <div class="post-content" style="display: flex; gap: 20px;">
        <!-- Â∑¶ÔºöÂãïÁîª„Å®„Çø„Ç§„Éà„É´ -->
        <div class="left-column" style="flex: 1;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h3 style="margin-bottom: 5px;">
                <%= post.title.presence || "Ôºà„Çø„Ç§„Éà„É´Êú™ÂÖ•ÂäõÔºâ" %>
              </h3>
              <p style="margin-top: 0; font-size: 0.9em;">
                <strong></strong> <%= post.category.name if post.category.present? %>
              </p>
            </div>

            <div onclick="event.stopPropagation();">
              <%= render "posts/like_button", post: post %>
            </div>
          </div>

          <iframe width="100%" height="169"
                  src="<%= youtube_embed_url(post.video_url) %>"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen>
          </iframe>

          <p><strong>ÊäïÁ®øËÄÖ:</strong> <%= post.user.nickname %></p>
        </div>

        <!-- ‰∏≠Â§ÆÔºöÊ≠åË©û -->
        <div class="center-column" style="flex: 1;">
          <p>
            <%= truncate(post.lyrics, length: 100) %>
          </p>
        </div>

        <!-- Âè≥Ôºö„É°„É¢ -->
        <div class="right-column" style="flex: 1;">
          <p>
            <%= truncate(post.memo, length: 100) %>
          </p>
        </div>
      </div>

    <% end %>
  </div>
<% end %>

<% if user_signed_in? %>
  <!-- üéµ „Éó„É¨„Ç§„É™„Çπ„Éà‰ΩúÊàê or ËøΩÂä† „É¢„Éº„ÉÄ„É´ -->
  <div class="modal fade" id="playlistModal" tabindex="-1" aria-labelledby="playlistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <%= form_with url: playlist_items_path, method: :post, id: "playlist-add-form", local: false do %>
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <input type="hidden" name="post_id" id="playlist_post_id">

          <div class="modal-header">
            <h5 class="modal-title" id="playlistModalLabel">„Éó„É¨„Ç§„É™„Çπ„Éà„Å´ËøΩÂä†</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Èñâ„Åò„Çã"></button>
          </div>

          <div class="modal-body">
            <!-- üéµ Êñ∞Ë¶è‰ΩúÊàêÊ¨Ñ -->
            <div class="mb-3">
              <label for="new_playlist_name" class="form-label">Êñ∞„Åó„ÅÑ„Éó„É¨„Ç§„É™„Çπ„ÉàÂêçÔºà‰ªªÊÑèÔºâ</label>
              <input type="text" name="new_playlist_name" id="new_playlist_name" class="form-control">
            </div>

            <!-- üéµ Êó¢Â≠ò„Éó„É¨„Ç§„É™„Çπ„ÉàÈÅ∏Êäû -->
            <div class="mb-3">
              <label for="existing_playlist_id" class="form-label">Êó¢Â≠ò„ÅÆ„Éó„É¨„Ç§„É™„Çπ„Éà</label>
              <select name="existing_playlist_id" id="existing_playlist_id" class="form-select">
                <option value="">-- ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>
                <% current_user.playlists.each do |playlist| %>
                  <option value="<%= playlist.id %>"><%= playlist.name %></option>
                <% end %>
              </select>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
            <button type="submit" class="btn btn-primary">ËøΩÂä†„Åô„Çã</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
